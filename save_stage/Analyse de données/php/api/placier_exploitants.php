<?php

/**
 * Informations relatives exploitants d'une ville donnée, triés par année
 */

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json");

require_once("common.php");

$result = array();

if (isset($_GET["ville"]) && $_GET["ville"] != "") {

    // Connexion à la base de données

    require_once("../db/oracle_conn.php");

    // Récupération des données

    if ($conn) {
        $result["records"] = array();

        $activites_commerciales = array();
        foreach ($conn->query("SELECT ACO_NOM FROM ACTIVITECOMMERCIALE_LANGUE WHERE LAN_REF = 1") as $activite_commerciale) {
            $activites_commerciales[$activite_commerciale["ACO_NOM"]]["nombre"] = 0;
        }
        
        foreach ($conn->query("SELECT ACO_REF, DCREAT, EXP_DATE_CESSATION FROM EXPLOITANT WHERE EXP_VISIBLE = 1 AND EXP_VALIDE = 1") as $exploitant) {
            $exp_date = $exploitant["DCREAT"];
            $exp_date_cessation = $exploitant["EXP_DATE_CESSATION"];
            $aco_ref = $exploitant["ACO_REF"];
            $aco_nom = NULL;
            if ($aco_ref) {
                $aco_nom = $conn->query("SELECT ACO_NOM FROM ACTIVITECOMMERCIALE_LANGUE WHERE LAN_REF = 1 AND ACO_REF = $aco_ref")->fetch()[0];
            }            

            $annee = get_year($exp_date);
            $mois = get_month($exp_date);

            // Création ou récupération de l'année

            if (!array_key_exists($annee, $result["records"])) {
                $result["records"][$annee]["nombre"] = 0;
                $result["records"][$annee]["activités_commerciales"] = $activites_commerciales;
                for ($i = 1; $i <= 12; ++$i) {
                    $result["records"][$annee]["mois"][$i]["nombre"] = 0;
                    $result["records"][$annee]["mois"][$i]["activités_commerciales"] = $activites_commerciales;
                }
            }

            // Donnée : Nombre ++

            $result["records"][$annee]["nombre"] += 1;
            $result["records"][$annee]["mois"][$mois]["nombre"] += 1;

            if ($aco_nom) {
                $result["records"][$annee]["activités_commerciales"][$aco_nom]["nombre"] += 1;
                $result["records"][$annee]["mois"][$mois]["activités_commerciales"][$aco_nom]["nombre"] += 1;
            }
            
            if ($exp_date_cessation !== NULL) {
                $annee = get_year($exp_date);
                $mois = get_month($exp_date);

                // Création ou récupération de l'année

                if (!array_key_exists($annee, $result["records"])) {
                    $result["records"][$annee]["nombre"] = 0;
                    for ($i = 1; $i <= 12; ++$i) {
                        $result["records"][$annee]["mois"][$i]["nombre"] = 0;
                    }
                }
                
                // Donnée : Nombre --

                $result["records"][$annee]["nombre"] -= 1;
                $result["records"][$annee]["mois"][$mois]["nombre"] -= 1;

                if ($aco_nom) {
                    $result["records"][$annee]["activités_commerciales"][$aco_nom]["nombre"] -= 1;
                    $result["records"][$annee]["mois"][$mois]["activités_commerciales"][$aco_nom]["nombre"] -= 1;
                }
            }
        }
    }
} else {
    $result["error"]["reason"] = "Donner le nom de la ville";
    $result["error"]["example"] = "Exemple : placier_exploitants.php?ville=angers";
}

echo json_encode($result);

?>
