<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>API Entreprise</title>
    <link rel="stylesheet" type="text/css" href="paper.css">
</head>

<body>

	<section>

		<article>
			<h2>Privil√®ges du token</h2>

			<p>
				<input onchange="display_privileges()" id="token" value="OraehahG8Uunahligh3thaez" />
				<button onclick="display_privileges()">&#10004;</button>
			</p>
		</article>

		<article>
			<h2>Recherche par SIREN</h2>

			<p>
				<input onchange="search_by_siren()" id="siren" type="text" value="441354776" placeholder="SIREN" />
				<button onclick="search_by_siren()">&#10004;</button>
			</p>
		</article>

	</section>

	<section id="res">
	</section>

</body>

<script>
/*
function callOtherDomain(url) {
	invocation = new XMLHttpRequest(); 
	console.log(url);
	invocation.open('GET', url, true);
	invocation.withCredentials = true;
	invocation.onreadystatechange = ok(invocation);
	invocation.send(); 
}

function ok(invocation) {
	console.log(invocation.responseText);
	console.log("=======");
}

// callOtherDomain("http://bar.other/resources/public-data/");
// callOtherDomain("https://www.google.fr");
// callOtherDomain("https://entreprise.api.gouv.fr/v2/privileges?token=OraehahG8Uunahligh3thaez");
*/

// Tuto : https://openclassrooms.com/courses/ajax-et-l-echange-de-donnees-en-javascript/l-xmlhttprequest-cross-domain
// CORES in action : http://arunranga.com/examples/access-control/
// Explications : http://blog.inovia-conseil.fr/?p=202

var token = document.querySelector("#token");
var siren = document.querySelector("#siren");
var res_dom = document.querySelector("#res");

display_privileges();
function display_privileges() {
	call_api("privileges", res_dom);
}

function search_by_siren() {
	call_api("entreprises/" + siren.value, res_dom);
}

function call_api(endpoint, dom) {
	var url = "https://entreprise.api.gouv.fr/v2/" + endpoint + "?token=" + token.value;
	res_dom.innerHTML = "<i>Loading...</i>";

	var xhr = new XMLHttpRequest();
	// xhr.withCredentials = true;
	xhr.onload = function() {
		var res = JSON.parse(xhr.responseText);
		dom.innerHTML = "<pre><a target='_blank' href='" + url + "'>" + url + "</a></pre>";
		dom.innerHTML += "<pre>" + JSON.stringify(res, null, 4) + "</pre>";
	};
	xhr.open("GET", url, true);
	xhr.send();
}

</script>
