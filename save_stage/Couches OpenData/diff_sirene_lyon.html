<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>Comparaison table exploitants/base SIRENE</title>
    <link rel="stylesheet" type="text/css" href="paper.css">
</head>

<body onload="ajax('http://localhost:8080/sirene/exploitants_lyon.php?limit=' + limit, load_table, null)">
    <section>
        <article>
            <h2>Comparaison table exploitants/base SIRENE</h2>

            La table a été mise à jour le 8 janvier 2018, la base SIRENE est mise à jour en temps réel mais les données de chaque entreprise ne sont pas vérifiées à chaque màj.
            <br>
            Note : la table de Lyon provient d'une base entreprise de La Poste

            <div id="diff"></div>

        </article>
    </section>
</body>

<script>

/* 03/04/2018

282 / 1506 entreprises de la table de Lyon sont derrière l'API
13 entreprises sont derrière l'API et conflictuelles (à mettre à jour avec l'API)

1224 / 1506 entreprises de l'API sont derrière la table
1224 entreprises sont derrière la table et conflictuelles (soit plus précises, soit non renseignées, soit éronnées)

*/

console.log("nb_companies_loaded n'atteint parfois pas nb_companies_displayed");
console.log("Forcer le message de fin en tapant conclude()");

var last_table_update = "01/08/2018";

var api_key = "b739c79c6473471f38d30f3e0259b8f42c101ef7bb8d93d3ddc6a169";

var diff = document.querySelector("#diff");
var table_columns = [
                    "EXP_NOM_PERS_PHYSIQUE",
                    "EXP_PRENOM_PERS_PHYSIQUE",
                    "EXP_RAISON_SOCIALE",
                    "EXP_APE",
                    "EXP_ADRESSE",
                    "EXP_VILLE",
                    "EXP_TELEPHONE",
                    "EXP_EMAIL",
                ];
var api_columns = [
                    "nom",
                    "prenom",
                    "nomen_long",
                    "apet700",
                    "libvoie",
                    "libcom",
                    "tel",
                    "adr_mail",
                ];

var table_datas = Array();
var api_datas = Array();

var start = 0;
var limit = 100;

var nb_companies_loaded = 0;
var nb_companies_displayed = 0;
var nb_companies_gladiatorial = 0;
var nb_companies_behind_on_api = 0;
var nb_companies_late_on_api = 0; // late = derrière et avec au moins un conflit

// var CONTINUER = false;

function load_table(response_text) {
    // CONTINUER = (!CONTINUER) ? true : false;

	companies_json = JSON.parse(response_text);
    // nb_companies_loaded += limit; // FAUX, car companies_json.nhits peut retourner moins de résultats que la limite, car il y a un traitement dans le PHP : le script ne retourne pas les non-siret
    nb_companies_loaded += companies_json.nhits;

    if (companies_json.nhits > 0) {
        for (var company of companies_json.records) {
            var fields = company.fields;
            table_datas.push(fields);
            var api_fields = ajax("https://data.opendatasoft.com/api/v2/catalog/datasets/sirene%40public/records/?apikey=" + api_key + "&rows=1&where=siret = '" + fields.EXP_SIRET + "'", load_sirene, table_datas.length - 1);
        }

        // if (CONTINUER) {
            start += limit;
            ajax("http://localhost:8080/sirene/exploitants_lyon.php?start=" + start + "&limit=" + limit, load_table, null);
        // }
    }
}

function load_sirene(response_text, index) {
	companies_json = JSON.parse(response_text);

    if (companies_json.error || companies_json.total_count == 0) {
        api_datas[index] = null;
    } else {
        api_datas[index] = companies_json.records[0].record.fields;
    }

    compare(index);
}

function ajax(url, callback, args) {
	var xhr = new XMLHttpRequest();
	xhr.open("GET", url, true);
	xhr.onload = function() {
		callback(xhr.responseText, args);
	};
	xhr.send();
}

function compare(index) {
    var table = document.createElement("table");
        table.className = "dezoom";
        diff.appendChild(table);
    
    var row = document.createElement("tr");
        table.appendChild(row);
        row.innerHTML = "<th style=\"text-align: center;\" colspan=\"4\">" + table_datas[index]["EXP_SIRET"] + "</th>";

    if (api_datas[index] == null) {
        var row = document.createElement("tr");
            table.appendChild(row);
        row.innerHTML = "<td></td><td></td><td>Entreprise radiée</td><td><state class=\"red\">&#11044;</state></td>";
    } else {
        // conflit <=> api.date > table.date & api.datas != table.datas
        // late_api <=> api.date < table.date & api.datas != table.datas

        if (new Date(api_datas[index]["datemaj"]) > new Date(last_table_update)) {
            var row = document.createElement("tr");
                table.appendChild(row);
            row.innerHTML = "<td></td><td></td><td>API devant</td><td><state class=\"orange\">&#11044;</state></td>";

            var row = document.createElement("tr");
                table.appendChild(row);
                row.innerHTML = "<th></th><th>Datas table</th><th>Datas API</th><th></th>";

            var conflit = false;

            for (var i = 0; i < table_columns.length; ++i) {
                var row = document.createElement("tr");
                    table.appendChild(row);

                var table_data = table_datas[index][table_columns[i]];
                var api_data = api_datas[index][api_columns[i]];

                if (table_data != null && api_data != null && levenshtein_distance(table_data, api_data) <= 3) {
                    state = "green";
                } else {
                    state = "red";
                    conflit = true;
                }

                row.innerHTML = "<th>" + table_columns[i] + "</th><td>" + table_data + "</td><td>" + api_data + "</td><td><state class=\"" + state + "\">&#11044;</state></td>";
            }

            if (conflit) ++nb_companies_gladiatorial;
        } else {
            ++nb_companies_behind_on_api;

            var row = document.createElement("tr");
                table.appendChild(row);
            row.innerHTML = "<td></td><td>Table devant</td><td></td><td><state class=\"green\">&#11044;</state></td>";

            var row = document.createElement("tr");
                table.appendChild(row);
                row.innerHTML = "<th></th><th>Datas table</th><th>Datas API</th><th></th>";

            var late_api = false;

            for (var i = 0; i < table_columns.length; ++i) {
                var row = document.createElement("tr");
                    table.appendChild(row);

                var table_data = table_datas[index][table_columns[i]];
                var api_data = api_datas[index][api_columns[i]];

                if ((table_data === api_data) || (table_data != null && api_data != null && levenshtein_distance(table_data, api_data) <= 3)) {
                    state = "green";
                } else {
                    state = "";
                    late_api = true;
                }

                row.innerHTML = "<th>" + table_columns[i] + "</th><td>" + table_data + "</td><td>" + api_data + "</td><td><state class=\"" + state + "\">&#11044;</state></td>";
            }

            if (late_api) ++nb_companies_late_on_api;
        }
    }

    ++nb_companies_displayed;

    if (nb_companies_displayed == nb_companies_loaded || nb_companies_displayed % 1000 == 0) conclude();
}

function conclude() {
    var conclusion = document.createElement("p");
        conclusion.innerHTML += nb_companies_displayed - nb_companies_behind_on_api + " / " + nb_companies_displayed + " entreprises de la table de Lyon sont derrière l'API<br>";
        conclusion.innerHTML += nb_companies_gladiatorial + " entreprises sont derrière l'API et conflictuelles (à mettre à jour avec l'API)<br>";
        conclusion.innerHTML += "<br>";
        conclusion.innerHTML += nb_companies_behind_on_api + " / " + nb_companies_displayed + " entreprises de l'API sont derrière la table<br>";
        conclusion.innerHTML += nb_companies_late_on_api + " entreprises sont derrière la table et conflictuelles (soit plus précises, soit non renseignées, soit éronnées)<br>";
        diff.appendChild(conclusion);
}

// https://gist.github.com/andrei-m/982927
function levenshtein_distance(a, b) {
    if (a.length == 0) return b.length; 
    if (b.length == 0) return a.length; 

    var matrix = [];

    // increment along the first column of each row
    var i;
        for (i = 0; i <= b.length; i++) {
        matrix[i] = [i];
    }

    // increment each column in the first row
    var j;
        for (j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
    }

    // Fill in the rest of the matrix
    for (i = 1; i <= b.length; i++) {
        for (j = 1; j <= a.length; j++) {
            if (b.charAt(i-1) == a.charAt(j-1)) {
                matrix[i][j] = matrix[i-1][j-1];
            } else {
                matrix[i][j] =  Math.min(matrix[i-1][j-1] + 1, // substitution
                                Math.min(matrix[i][j-1] + 1, // insertion
                                matrix[i-1][j] + 1)); // deletion
            }
        }
    }

    return matrix[b.length][a.length];
}

</script>
