<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>API JCDecaux</title>
    <link rel="stylesheet" type="text/css" href="paper.css">
</head>

<body>

	<section>
		<article>
			<h2>Informations du token</h2>

			<p>
				Clé :<br>
				<input id="token" type="text" value="11c4f1ced2617e66a186743cccf5b6d1a122f262" />
			</p>
		</article>

		<article>
			<h2>Recherche</h2>

			<p>
				<input onchange="search()" id="city" type="text" value="Nantes" placeholder="Ville" />
				<button onclick="search()">&#10004;</button>
			</p>

		</article>

		<article id="stations" class="hidden">
		</article>
	</section>

</body>

<script>

var token = document.querySelector("#token");
var city = document.querySelector("#city");

var stations_dom = document.querySelector("#stations");

var stations_json = null;

var begin_search;
var end_search;

function search() {
	call_api("contract=" + city.value);
}

function call_api(endpoint) {
	var url = "https://api.jcdecaux.com/vls/v1/stations?apiKey=" + token.value + "&" + endpoint;

	stations_dom.className = "";
	stations_dom.innerHTML = "<h2>Vélos JCDecaux en libre service</h2>";
	stations_dom.innerHTML += "<i>Loading...</i>";

	begin_search = new Date().getTime();

	ajax(url, display, null);
}

function ajax(url, callback, args) {
	var xhr = new XMLHttpRequest();
	xhr.open("GET", url, true);
	xhr.onload = function() {
		callback(xhr.responseText, args);
	};
	xhr.send();
}

function display(response_text, args) {
	end_search = new Date().getTime();

	stations_json = JSON.parse(response_text);

	stations_dom.removeChild(stations_dom.lastChild);
	stations_dom.innerHTML += stations_json["length"] + " résultat(s) - " + parseInt(end_search - begin_search) + " ms";

	var columns = ["name", "status", "available_bike_stands", "available_bikes", "last_update", "position"];
	
	stations_dom.innerHTML = stations_json.length + " résultat(s) - " + parseInt(end_search - begin_search) + " ms";

	var table = document.createElement("table");
	table.className = "full dezoom";
	stations_dom.appendChild(table);
	var row = document.createElement("tr");
	for (col of columns) row.innerHTML += "<th>" + col.toUpperCase() + "</th>";
	table.appendChild(row);

	for (var station of stations_json) {
		var row = document.createElement("tr");
		for (property of columns) {
			var value = station[property];
			if (value == undefined) value = "";
			if (value.length > 50) value = value.substr(0, 50) + "...";
			if (property == "status" && value == "OPEN") value = "<state class=\"green\">&#11044;</state>";
			if (property == "status" && value == "CLOSED") value = "<state class=\"red\">&#11044;</state>";
			if (property == "last_update") {
				var a = new Date(value);
				var months = ['jan.', 'fev.', 'mars','avril', 'mai','juin','juil.','aou.','sep.','oct.','nov.','dec.'];
				value = a.getDate() + " " + months[a.getMonth()] + " " + a.getFullYear();
			}
			if (property == "position") value = "<a href='https://www.google.fr/search?q=" + value["lat"] + "," + value["lng"] + "'>&#128506;</a>";
			row.innerHTML += "<td>" + value + "</td>";
		}
		table.appendChild(row);
	}
}

</script>
