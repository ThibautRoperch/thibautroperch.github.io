<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>Solution tableau de bord</title>
    <link rel="stylesheet" type="text/css" href="paper.css">
</head>

<body onload="ajax('http://www.ac-grenoble.fr/disciplines/informatiquelycee/asset/departments.json', load_map, null)">

	<section>
		<article>
			<h2>Recherche</h2>

			<p>
				<input onchange="search()" id="city" type="text" value="Anger" placeholder="Ville" />
				<select onchange="search()" id="format" ><option value="json">json</option><option value="geojson" selected>geojson</option></select>
				<button onclick="search()">&#10004;</button>
			</p>

		</article>

		<article id="informations" class="hidden">
		</article>

		<article id="france">
		</article>
	</section>

</body>

<script src="expand.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>

<script>

var city = document.querySelector("#city");
var format = document.querySelector("#format");

var informations_dom = document.querySelector("#informations");

var informations_json = null;
var map_json = null;

var begin_search;
var end_search;

function load_map(response_text, args) {
	map_json = JSON.parse(response_text);
}

function search() {
	if (format.value == "json") {
		call_api_informations_json("nom=" + city.value);
	} else if (format.value == "geojson") {
		call_api_informations_geojson("nom=" + city.value);
	}
}

function call_api_informations_json(endpoint) {
	var end = "&fields=code,nom,codesPostaux,codeDepartement,codeRegion,departement,region,population,surface,centre,contour&format=json"
	var url = "https://geo.api.gouv.fr/communes?" + endpoint + end;

	informations_dom.className = "";
	informations_dom.innerHTML = "<h2>Informations</h2>";
	informations_dom.innerHTML += "<i>Loading...</i>";

	begin_search = new Date().getTime();

	ajax(url, display_informations_json, null);
}

function call_api_informations_geojson(endpoint) {
	var end = "&fields=code,nom,codesPostaux,codeDepartement,codeRegion,departement,region,population,surface,centre,contour&format=geojson&geometry=contour"
	var url = "https://geo.api.gouv.fr/communes?" + endpoint + end;

	informations_dom.className = "";
	informations_dom.innerHTML = "<h2>Informations</h2>";
	informations_dom.innerHTML += "<i>Loading...</i>";

	begin_search = new Date().getTime();

	ajax(url, display_informations_geojson, null);
}

function ajax(url, callback, args) {
	var xhr = new XMLHttpRequest();
	xhr.open("GET", url, true);
	xhr.onload = function() {
		callback(xhr.responseText, args);
	};
	xhr.send();
}

function display_informations_json(response_text, args) {
	end_search = new Date().getTime();

	informations_json = JSON.parse(response_text);

	informations_dom.removeChild(informations_dom.lastChild);
	informations_dom.innerHTML += informations_json["length"] + " résultat(s) - " + parseInt(end_search - begin_search) + " ms";
	
	var list = document.createElement("ul");
	list.className = "wrapper";
		informations_dom.appendChild(list);

	for (var city of informations_json) {
		var item = document.createElement("li");
			list.appendChild(item);
		var header = document.createElement("header");
			item.appendChild(header);
		var section = document.createElement("section");
			item.appendChild(section);
		
		header.onclick = function() { expand-expand(this); };
		header.innerHTML = "<h3>" + city["nom"] + "</h3>";
		
		var table = document.createElement("table");
			section.appendChild(table);

		table.innerHTML += "<tr><th>Code</th><td>" + city["code"] + "</td></tr>";
		table.innerHTML += "<tr><th>Département</th><td>" + city["departement"]["nom"] + "</td></tr>";
		table.innerHTML += "<tr><th>Région</th><td>" + city["region"]["nom"] + "</td></tr>";
		table.innerHTML += "<tr><th>Codes postaux</th><td>" + city["codesPostaux"] + "</td></tr>";
		table.innerHTML += "<tr><th>Population</th><td>" + city["population"] + " habitants</td></tr>";
		table.innerHTML += "<tr><th>Surface</th><td>" + city["surface"] + " m²</td></tr>";
	}
}

function display_informations_geojson(response_text, args) {
	end_search = new Date().getTime();

	informations_json = JSON.parse(response_text)["features"];

	informations_dom.removeChild(informations_dom.lastChild);
	informations_dom.innerHTML += informations_json["length"] + " résultat(s) - " + parseInt(end_search - begin_search) + " ms";
	
	var list = document.createElement("ul");
	list.className = "wrapper";
		informations_dom.appendChild(list);

	for (var city of informations_json) {
		var properties = city["properties"];

		var item = document.createElement("li");
			list.appendChild(item);
		var header = document.createElement("header");
			item.appendChild(header);
		var section = document.createElement("section");
			item.appendChild(section);
		
		header.onclick = function() { expand-expand(this); };
		header.innerHTML = "<h3>" + properties["nom"] + "</h3>";
		
		var cols = document.createElement("cols");
		section.append(cols);

		var table = document.createElement("table");
			cols.appendChild(table);

		table.innerHTML += "<tr><th>Code</th><td>" + properties["code"] + "</td></tr>";
		table.innerHTML += "<tr><th>Département</th><td>" + properties["departement"]["nom"] + "</td></tr>";
		table.innerHTML += "<tr><th>Région</th><td>" + properties["region"]["nom"] + "</td></tr>";
		table.innerHTML += "<tr><th>Code région</th><td>" + properties["codeRegion"] + "</td></tr>";
		table.innerHTML += "<tr><th>Code département</th><td>" + properties["codeDepartement"] + "</td></tr>";
		table.innerHTML += "<tr><th>Codes postaux</th><td>" + properties["codesPostaux"] + "</td></tr>";
		table.innerHTML += "<tr><th>Population</th><td>" + properties["population"] + " habitants</td></tr>";
		table.innerHTML += "<tr><th>Surface</th><td>" + properties["surface"] + " m²</td></tr>";

		var width_height = 300;
		var scale = 1300;
		var map = document.createElement("div");
			map.className = "svgs";
			map.style.width = width_height + "px";
			map.style.height = width_height + "px";
			cols.appendChild(map);
		draw_geojson(map, map_json.features, width_height, width_height, scale, "black");
		draw_geojson(map, informations_json, width_height, width_height, scale, "red");
	}
}

function draw_polygon(dom, coordinates) {
	var context = dom.getContext('2d');

	context.fillStyle = '#f00';
	context.beginPath();
	context.moveTo(50, 50);

	for (coo of coordinates) {
		console.log(coo[0], coo[1]);
		context.lineTo(coo[0]*10, coo[1]*10);
	}

	context.closePath();
	context.fill();
}

function draw_geojson(dom, datas, width, height, scale, color) {
	var dom = d3.select(dom);
	var svg = dom.append("svg")
		.attr("width", width)
		.attr("height", height)

	var path = d3.geoPath();
	var projection = d3.geoConicConformal()
		.center([2.454071, 46.279229])
		.scale(scale)
		.translate([width/2, height/2]);
	path.projection(projection);

	// VERIF DU CONTENU DES DATAS
	// console.log(datas);
	// dom.selectAll("p")
	// 	.data(datas)
	// 	.enter()
	// 	.append("p")
	// 	.attr("style", "border-bottom:1px solid white;background:rgba(100, 50, 20, 0.1)")
	// 	.text(path);
	// FIN VERIF

    var map = svg.selectAll("path").data(datas);
    map.enter()
        .append("path")
        .attr("d", path)
		.attr("fill", color)
		// .attr("stroke", "rgba(255, 255, 255, 0.1)")
		.on("mouseover", function() {
			d3.select(this)
				.attr("fill", "rgba(255, 255, 255, 0.1)");
		})
		.on("mouseout", function() {
			d3.select(this)
				.attr("fill", color)
		})
}

test_d3();
function test_d3() {
	var width = 700;
	var height = 600;

	var body = d3.select("#france");
	var svg = body.append("svg")
		.attr("width", width)
		.attr("height", height)
		.attr("style", "display:block;margin:auto;background:rgba(0, 0, 0, 0.1)");
		
	var path = d3.geoPath();
	var projection = d3.geoConicConformal()
		.center([2.454071, 46.279229])
		.scale(3000)
		.translate([width/2, height/2]);
	path.projection(projection);

	var tooltip = d3.select("body").append("tooltip");

	d3.json('departments.json', function(req, geo_json) {
		svg.selectAll("path") // pour chaque balise 'path' à générer
			.data(geo_json.features) // lire les données geo_json.features
			.enter() // entrer dans 'svg'
			.append("path") // ajouter une balise 'path' (un polygone en SVG)
			.attr("d", path) // attribution des coordonnées des points (attribut 'd' du polygone en SVG)
			.attr("fill", "black")
			// .attr("stroke", "rgba(255, 255, 255, 0.1)")
			.on("mouseover", function(d) {
				d3.select(this)
					.attr("fill", "rgba(255, 255, 255, 0.1)");
				tooltip
					.html("Département : " + d.properties.NOM_DEPT + "<br>" +  "Région : " + d.properties.NOM_REGION)
					.style("left", (d3.event.pageX + 40) + "px")
					.style("top", (d3.event.pageY - 20) + "px")
					.attr("class", "display");
			})
			.on("mouseout", function() {
				d3.select(this)
					.attr("fill", "black")
				tooltip.attr("class", "");
			})
	});

	var pre = body.append("pre");
	d3.json('departments.json', function(req, geo_json) {
		pre.selectAll("p")
			.data(geo_json.features)
			.enter()
			.append("p")
			.attr("style", "border-bottom:1px solid white;background:rgba(100, 50, 20, 0.1)")
			.text(path);
	});
}

</script>

<style>

tooltip {
	position: absolute;
	display: none;
}

tooltip.display {
	display: block;
	padding: 5px;
	font-size: 85%;
	background: darkslategray;
	z-index: 500;
	opacity: 0.5;
}

tooltip::before {
	content: "";
	position: absolute;
	display: block;
	width: 15px;
	height: 15px;
	margin-left: -11px;
	margin-top: 8px;
	transform: rotate(45deg);
	background: darkslategray;
	z-index: -100;
}

</style>
	