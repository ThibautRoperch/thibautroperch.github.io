<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>API Cadastre</title>
    <link rel="stylesheet" type="text/css" href="paper.css">
</head>

<body onload="ajax('http://www.ac-grenoble.fr/disciplines/informatiquelycee/asset/departments.json', load_map, null)">

	<section>
		<article>
			<h2>Recherche</h2>

			<p>
				<input onchange="search()" id="city_code" type="text" value="49007" placeholder="Code de ville" />
				<button onclick="search()">&#10004;</button>
			</p>

		</article>

		<article id="city" class="hidden">
		</article>

		<article id="france">
		</article>
	</section>

</body>

<script src="expand.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>

<script>

var city_code = document.querySelector("#city_code");

var city_dom = document.querySelector("#city");

var res_json = null;
var map_json = null;

var begin_search;
var end_search;

var to_px = 0.02;

function load_map(response_text, args) {
	map_json = JSON.parse(response_text);
	test_d3();
}

function search() {
	call_api(city_code.value + "/geojson/communes");
	// call_api(city_code.value + "/geojson/sections");
	// call_api(city_code.value + "/geojson/feuilles");
	// call_api(city_code.value + "/geojson/parcelles");
	// call_api(city_code.value + "/geojson/batiments");
	// call_api(city_code.value + "/geojson/lieux_dits");
}

function call_api(endpoint) {
	var url = "https://cadastre.data.gouv.fr/bundler/cadastre-etalab/communes/" + endpoint;

	city_dom.className = "";
	city_dom.innerHTML = "<h2>Commune</h2>";
	city_dom.innerHTML += "<i>Loading...</i>";

	begin_search = new Date().getTime();

	ajax(url, display, null);
}

function ajax(url, callback, args) {
	var xhr = new XMLHttpRequest();
	xhr.open("GET", url, true);
	xhr.onload = function() {
		callback(xhr.responseText, args);
	};
	xhr.send();
}

function display(response_text, args) {
	end_search = new Date().getTime();

	res_json = JSON.parse(response_text)["features"];

	city_dom.removeChild(city_dom.lastChild);
	city_dom.innerHTML += res_json["length"] + " résultat(s) - " + parseInt(end_search - begin_search) + " ms";

	var width = 400;
	var height = 300;
	var map = document.createElement("div");
		map.className = "svgs";
		map.style.width = width + "px";
		map.style.height = height + "px";
		city_dom.appendChild(map);

	var points = res_json[0]["geometry"]["coordinates"][0];
	if (points["length"] == 1) points = points[0]; // des fois, il y a un sur-array supplémentaire
	var min = [undefined, undefined]; // min x, min y
	var max = [undefined, undefined]; // max x, max y
	for (point of points) {
		for (var i = 0; i <= 1; ++i) {
			if (min[i] == undefined || point[i] < min[i]) {
				min[i] = point[i];
			}
			if (max[i] == undefined || point[i] > max[i]) {
				max[i] = point[i];
			}
		}
	}

	var city_width = max[0] - min[0];
	var city_height = max[1] - min[1];

	var center = [(min[0] + max[0]) / 2, (min[1] + max[1]) / 2];
	var scale = Math.min(width / (city_width * to_px), height / (city_height * to_px));
	var translation = [(width + center[0]/2) / 2, (height + center[1]/2) / 2]

	// draw_geojson(map, map_json.features, width, height, center, scale, translation, "black");
	draw_geojson(map, res_json, width, height, center, scale, translation, "silver");
}

function draw_polygon(dom, coordinates) {
	var context = dom.getContext('2d');

	context.fillStyle = '#f00';
	context.beginPath();
	context.moveTo(50, 50);

	for (coo of coordinates) {
		console.log(coo[0], coo[1]);
		context.lineTo(coo[0]*10, coo[1]*10);
	}

	context.closePath();
	context.fill();
}

function draw_geojson(dom, datas, width, height, center, scale, translation, color) {
	var dom = d3.select(dom);
	var svg = dom.append("svg")
		.attr("width", width)
		.attr("height", height)

	var path = d3.geoPath();
	var projection = d3.geoConicConformal()
		.center(center)
		.scale(scale)
		.translate(translation);
	path.projection(projection);

	// VERIF DU CONTENU DES DATAS
	// console.log(datas);
	// var pre = dom.parentNode.append("pre");
	// pre.selectAll("p")
	// 	.data(datas)
	// 	.enter()
	// 	.append("p")
	// 	.attr("style", "border-bottom:1px solid white;background:rgba(100, 50, 20, 0.1)")
	// 	.text(path);
	// FIN VERIF

    var map = svg.selectAll("path").data(datas);
    map.enter()
        .append("path")
        .attr("d", path)
		.attr("fill", color)
		// .attr("stroke", "rgba(255, 255, 255, 0.1)")
}

function test_d3() {
	var width = 700;
	var height = 600;
	var center = [2.454071, 46.279229];
	var scale = 3000;
	var translation = [width / 2, height / 2];

	// CALCUL DES DIMENSIONS
	var zones = map_json["features"];
	var min = [undefined, undefined]; // min x, min y
	var max = [undefined, undefined]; // max x, max y
	for (zone of zones) {
		var points = zone["geometry"]["coordinates"][0];
		if (points["length"] == 1) points = points[0]; // des fois, il y a un sur-array supplémentaire
		// console.log(points);
		var b = 0;
		for (point of points) {
			for (var i = 0; i <= 1; ++i) {
				if (min[i] == undefined || point[i] < min[i]) {
					min[i] = point[i];
				}
				if (max[i] == undefined || point[i] > max[i]) {
					max[i] = point[i];
				}
			}
			++b;
		}
		// console.log(b);
	}

	// console.log("=== MIN[x, y] MAX[x, y] ===");
	// console.log(min);
	// console.log(max);

	// console.log("=== COMPUTED WIDTH HEIGHT ===");
	var c_width = max[0] - min[0];
	var c_height = max[1] - min[1];
	// console.log(c_width);
	// console.log(c_height);

	// console.log("=== COMPUTED CENTER SCALE TRANSLATION ===");
	var c_center = [(min[0] + max[0]) / 2, (min[1] + max[1]) / 2];
	var c_scale = Math.min(width / (c_width * to_px), height / (c_height * to_px));
	var c_translation = [(width + c_center[0]/2) / 2, (height + c_center[1]/2) / 2]
	// console.log(c_center);
	// console.log(c_scale);
	// console.log(c_translation);

	// console.log("=== WANTED WIDTH HEIGHT ===");
	// console.log(width);
	// console.log(height);

	// console.log("=== GIVEN CENTER SCALE TRANSLATION ===");
	// console.log(center);
	// console.log(scale);
	// console.log(translation);
	// FIN CALCUL

	var body = d3.select("#france");
	var svg = body.append("svg")
		.attr("width", width)
		.attr("height", height)
		.attr("style", "display:block;margin:auto;background:rgba(0, 0, 0, 0.1)");
		
	var path = d3.geoPath();
	var projection = d3.geoConicConformal()
		.center(c_center)
		.scale(c_scale)
		.translate(c_translation);
	path.projection(projection);

	var tooltip = d3.select("body").append("tooltip");

	d3.json('departments.json', function(req, geo_json) {
		svg.selectAll("path") // pour chaque balise 'path' à générer
			.data(geo_json.features) // lire les données geo_json.features
			.enter() // entrer dans 'svg'
			.append("path") // ajouter une balise 'path' (un polygone en SVG)
			.attr("d", path) // attribution des coordonnées des points (attribut 'd' du polygone en SVG)
			.attr("fill", "black")
			// .attr("stroke", "rgba(255, 255, 255, 0.1)")
			.attr("cursor", "pointer")
			.on("mouseover", function(d) {
				d3.select(this)
					.attr("fill", "rgba(255, 255, 255, 0.1)");
				tooltip
					.html("Département : " + d.properties.NOM_DEPT + "<br>" +  "Région : " + d.properties.NOM_REGION)
					.style("left", (d3.event.pageX + 40) + "px")
					.style("top", (d3.event.pageY - 20) + "px")
					.attr("class", "display");
			})
			.on("mousemove", function() {
				tooltip
					.style("left", (d3.event.pageX + 40) + "px")
					.style("top", (d3.event.pageY - 20) + "px")
			})
			.on("mouseout", function() {
				d3.select(this)
					.attr("fill", "black")
				tooltip.attr("class", "");
			})
	});

	// VERIF DU CONTENU DES DATAS
	var pre = body.append("pre");
	d3.json('departments.json', function(req, geo_json) {
		pre.selectAll("p")
			.data(geo_json.features)
			.enter()
			.append("p")
			.attr("style", "border-bottom:1px solid white;background:rgba(100, 50, 20, 0.1)")
			.text(path);
	});
	// FIN VERIF
}

</script>

<style>

tooltip {
	position: absolute;
	display: none;
}

tooltip.display {
	display: block;
	padding: 5px;
	font-size: 85%;
	background: darkslategray;
	z-index: 500;
	opacity: 0.5;
}

tooltip::before {
	content: "";
	position: absolute;
	display: block;
	width: 15px;
	height: 15px;
	margin-left: -11px;
	margin-top: 8px;
	transform: rotate(45deg);
	background: darkslategray;
	z-index: -100;
}

</style>
	