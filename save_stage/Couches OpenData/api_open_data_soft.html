<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>API OpenDataSoft</title>
    <link rel="stylesheet" type="text/css" href="paper.css">
</head>

<body>

	<section>
		<article>
			<h2>Liste des jeux de données</h2>

			<p>
				<input onchange="search()" id="keyword" type="text" placeholder="Mot clé">
				<button onclick="search()">&#10004;</button>

				<ie>couverture, collectivités, ...</ie>
			</p>

		</article>

		<article id="datasets" class="hidden">
		</article>

	</section>

</body>

<script>

var api_key = "9c3183ecfc09611f4ac81793f7b789a98c4005bea14e9e6518c9954d";

var keyword = document.querySelector("#keyword");

var datasets_dom = document.querySelector("#datasets");

var begin_search;
var end_search;

function search() {
	results = 0;
	call_api_v1("q=" + keyword.value);
}

function call_api_v1(endpoint) {
	var refine = ["language=fr", "source_domain=public"];
	var sort = "records_count"
	var rows = 2000;
	var url = "https://data.opendatasoft.com/api/datasets/1.0/search/?apikey=" + api_key + "&rows=" + rows;
	for (param of refine) {
		url += "&refine." + param;
	}
	url += "&sort=" + sort + "&" + endpoint;
	call_api(url, display_datas_v1);
}

function call_api(url, callback) {
	datasets_dom.className = "";
	datasets_dom.innerHTML = "<h2>Jeux de données</h2>";
	datasets_dom.innerHTML = "<i>Loading...</i>";

	begin_search = new Date().getTime();

	var xhr = new XMLHttpRequest();
	xhr.open("GET", url, true);
	xhr.onload = function() {
		callback(xhr.responseText);
	};
	xhr.send();
}

function display_datas_v1(response_text) {
	end_search = new Date().getTime();

	datasets_json = JSON.parse(response_text);

	console.log(datasets_json);
	datasets_dom.removeChild(datasets_dom.lastChild);
	datasets_dom.innerHTML += datasets_json["nhits"] + " résultat(s) - " + parseInt(end_search - begin_search) + " ms";

	var table = document.createElement("table");
	table.className = "full dezoom";
	datasets_dom.appendChild(table);

	for (var dataset of datasets_json.datasets) {
		var row = document.createElement("tr");
		table.appendChild(row);
		row.innerHTML += "<td>" + dataset.metas.title + "</td>";
		// row.innerHTML += "<td>" + dataset.metas.publisher + "</td>";
		row.innerHTML += "<td>" + dataset.metas.records_count + " enregistrements</td>";
		// row.innerHTML += "<td>" + dataset.metas.source_domain + "</td>";
		// row.innerHTML += "<td>" + dataset.metas.source_domain_title + "</td>";
		// row.innerHTML += "<td>" + dataset.metas.theme + "</td>";
		var a = new Date(dataset.metas.data_processed);
			var months = ['jan.', 'fev.', 'mars','avril', 'mai','juin','juil.','aout','sep.','oct.','nov.','déc.'];
			value = a.getDate() + " " + months[a.getMonth()] + " " + a.getFullYear();
		row.innerHTML += "<td>" + value + "</td>";
		// row.innerHTML += "<td>" + dataset.metas.description.substr(0, 50) + "</info></td>";
		row.innerHTML += "<td><a href=\"https://data.opendatasoft.com/explore/dataset/" + dataset.datasetid + "\">SOURCE</a></td>";
	}
}

function display_datas_v2() {
	// res dom : the entire response
	res_dom.innerHTML += "<pre>" + JSON.stringify(res_json, null, 4) + "</pre>";

	// records : some values
	var columns = ["siret", "apet700", "siren", "sigle", "nomen_long", "activite", "categorie", "coordonnees"];
	var table;

	total_results =  res_json["total_count"];

	if (new_search) {
		records_dom.innerHTML = total_results + " résultat(s) - " + parseInt(end_search - begin_search) + " ms";
		table = document.createElement("table");
		table.className = "full dezoom";
		records_dom.appendChild(table);
		var row = document.createElement("tr");
		for (col of columns) row.innerHTML += "<th>" + col.toUpperCase() + "</th>";
		table.appendChild(row);
	}

	for (var record of res_json["records"]) {
		var fields = record["record"]["fields"];
		var row = document.createElement("tr");
		for (property of columns) {
			var value = fields[property];
			if (value == undefined) value = "";
			if (value.length > 50) value = value.substr(0, 50) + "...";
			if (property == "coordonnees") value = "<a href='https://www.google.fr/search?q=" + value["lat"] + "," + value["lon"] + "'>&#128506;</a>";
			row.innerHTML += "<td>" + value + "</td>";
		}
		table.appendChild(row);
	}
	
}

</script>
