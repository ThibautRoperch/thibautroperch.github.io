<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>API Sinere via OpenDataSoft</title>
    <link rel="stylesheet" type="text/css" href="paper.css">
</head>

<body>

	<section>
		<article>
			<h2>Recherche</h2>

			<p>
				<input onchange="search()" id="searchword" type="text" value="441354776" placeholder="Information" />
				<input id="limit" type="number" placeholder="10" class="mini" />
				<select onchange="search()" id="version" ><option value="v1">V1</option><option value="v2">V2</option></select>
				<button onclick="search()">&#10004;</button>
				<ie>siret, siren, code postal, ville, raison sociale, ...</ie>
			</p>

		</article>

		<article id="records" class="hidden">
		</article>

	</section>
		
	<section id="res" class="hidden">
	</section>

</body>

<script>

var searchword = document.querySelector("#searchword");
var limit = document.querySelector("#limit");
var version = document.querySelector("#version");

var records_dom = document.querySelector("#records");
var res_dom = document.querySelector("#res");

var res_json = null;

var results;
var total_results;

var begin_search;
var end_search;

function search() {
	results = 0;
	if (version.value == "v1") {
		call_api_v1("q=" + searchword.value, true);
	} else if (version.value == "v2") {
		call_api_v2("search=" + searchword.value, true);
	}
}

function call_api_v1(endpoint, new_search) {
	var facets = "facet=rpet&facet=depet&facet=libcom&facet=siege&facet=libapet&facet=saisonat&facet=libnj&facet=libapen&facet=ess&facet=libtefen&facet=categorie&facet=proden&facet=vmaj1&facet=vmaj2&facet=vmaj3&facet=libtu&facet=liborigine&facet=libtca&facet=libreg_new&facet=nom_dept&facet=section";
	var rows = (limit.value === "") ? 10 : parseInt(limit.value);
	var url = "https://data.opendatasoft.com/api/records/1.0/search/?dataset=sirene%40public&" + endpoint + "&rows=" + rows + "&start=" + results + "&" + facets;
	results += rows;
	call_api(url, new_search, display_datas_v1);
}

function call_api_v2(endpoint, new_search) {
	var rows = (limit.value === "") ? 10 : parseInt(limit.value);
	var url = "https://data.opendatasoft.com/api/v2/catalog/datasets/sirene%40public/records?" + endpoint + "&rows=" + rows + "&start=" + results;
	results += rows;
	call_api(url, new_search, display_datas_v2);
}

function call_api(url, new_search, callback) {
	if (new_search) {
		records_dom.className = "";
		records_dom.innerHTML = "";
	} else {
		records_dom.removeChild(records_dom.lastChild);
	}

	records_dom.innerHTML += "<i>Loading...</i>";
	begin_search = new Date().getTime();

	var xhr = new XMLHttpRequest();
	xhr.open("GET", url, true);
	xhr.onload = function() {
		end_search = new Date().getTime();
		res_json = JSON.parse(xhr.responseText);
		res_dom.className = "";
		res_dom.innerHTML = "<pre><a target='_blank' href='" + url + "'>" + url + "</a></pre>";
		callback(new_search);
	};
	xhr.send();
}

function display_datas_v1(new_search) {
	// res dom : the entire response
	res_dom.innerHTML += "<pre>" + JSON.stringify(res_json, null, 4) + "</pre>";

	// records : some values
	var columns = ["siret", "apet700", "siren", "sigle", "nomen_long", "activite", "categorie", "coordonnees"];
	var table;

	total_results = res_json["nhits"];

	if (new_search) {
		records_dom.innerHTML = total_results + " résultat(s) - " + parseInt(end_search - begin_search) + " ms";
		table = document.createElement("table");
		table.className = "full dezoom";
		records_dom.appendChild(table);
		var row = document.createElement("tr");
		for (col of columns) row.innerHTML += "<th>" + col.toUpperCase() + "</th>";
		table.appendChild(row);
	} else {
		records_dom.removeChild(records_dom.lastChild);
		table = records_dom.getElementsByTagName("table")[0];
	}

	for (var record of res_json["records"]) {
		var fields = record["fields"];
		var row = document.createElement("tr");
		for (property of columns) {
			var value = fields[property];
			if (value == undefined) value = "";
			if (value.length > 50) value = value.substr(0, 50) + "...";
			if (property == "coordonnees") value = "<a href='https://www.google.fr/search?q=" + value[0] + "," + value[1] + "'>&#128506;</a>";
			row.innerHTML += "<td>" + value + "</td>";
		}
		table.appendChild(row);
	}

	if (results < total_results) {
		var more = document.createElement("button");
		more.className = "full";
		more.innerHTML = "Plus de résultats";
		more.onclick = function() { call_api_v1("q=" + searchword.value, false); };
		records_dom.appendChild(more);
	}
}

function display_datas_v2(new_search) {
	// res dom : the entire response
	res_dom.innerHTML += "<pre>" + JSON.stringify(res_json, null, 4) + "</pre>";

	// records : some values
	var columns = ["siret", "apet700", "siren", "sigle", "nomen_long", "activite", "categorie", "coordonnees"];
	var table;

	total_results =  res_json["total_count"];

	if (new_search) {
		records_dom.innerHTML = total_results + " résultat(s) - " + parseInt(end_search - begin_search) + " ms";
		table = document.createElement("table");
		table.className = "full dezoom";
		records_dom.appendChild(table);
		var row = document.createElement("tr");
		for (col of columns) row.innerHTML += "<th>" + col.toUpperCase() + "</th>";
		table.appendChild(row);
	} else {
		records_dom.removeChild(records_dom.lastChild);
		table = records_dom.getElementsByTagName("table")[0];
	}

	for (var record of res_json["records"]) {
		var fields = record["record"]["fields"];
		var row = document.createElement("tr");
		for (property of columns) {
			var value = fields[property];
			if (value == undefined) value = "";
			if (value.length > 50) value = value.substr(0, 50) + "...";
			if (property == "coordonnees") value = "<a href='https://www.google.fr/search?q=" + value["lat"] + "," + value["lon"] + "'>&#128506;</a>";
			row.innerHTML += "<td>" + value + "</td>";
		}
		table.appendChild(row);
	}

	if (results < total_results) {
		var more = document.createElement("button");
		more.className = "full";
		more.innerHTML = "Plus de résultats";
		more.onclick = function() { call_api_v1("q=" + searchword.value, false); };
		records_dom.appendChild(more);
	}
}

</script>
