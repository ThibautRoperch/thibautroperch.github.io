<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <title>Solution tableau de bord</title>
    <link rel="stylesheet" type="text/css" href="paper.css">
</head>

<body>

	<section>
		<article>
			<h2>Recherche</h2>

			<p>
				<input onchange="search()" id="city" type="text" value="Angers" placeholder="Ville" />
				<button onclick="search()">&#10004;</button>
			</p>

		</article>

		<article id="informations" class="hidden">
		</article>

		<article id="" class="hidden">
		</article>

	</section>

</body>

<script src="expand.js"></script>

<script>

// DOM des entrées des requêtes
var city = document.querySelector("#city");

// DOM des sorties des requêtes
var informations_dom = document.querySelector("#informations");

// Résultats JSON des requêtes
var informations_json = null;

// Mesure du temps de la requête des informations
var informations_begin_search;
var informations_end_search;

function search() {
	call_api_informations("nom=" + city.value);
}

function call_api_informations(endpoint) {
	var end = "&fields=code,nom,codesPostaux,codeDepartement,codeRegion,departement,region,population,surface,centre,contour&format=json"
	var url = "https://geo.api.gouv.fr/communes?" + endpoint + end;

	informations_dom.className = "";
	informations_dom.innerHTML = "<h2>Informations</h2>";
	informations_dom.innerHTML += "<i>Loading...</i>";

	informations_begin_search = new Date().getTime();

	ajax(url, display_informations, null);
}

function ajax(url, callback, args) {
	var xhr = new XMLHttpRequest();
	xhr.open("GET", url, true);
	xhr.onload = function() {
		callback(xhr.responseText, args);
	};
	xhr.send();
}

function display_informations(response_text, args) {
	informations_end_search = new Date().getTime();

	informations_json = JSON.parse(response_text);

	console.log(informations_json);

	informations_dom.removeChild(informations_dom.lastChild);
	informations_dom.innerHTML += informations_json["length"] + " résultat(s) - " + parseInt(informations_end_search - informations_begin_search) + " ms";
	
	var list = document.createElement("ul");
	list.className = "wrapper";
		informations_dom.appendChild(list);

	for (var city of informations_json) {
		var item = document.createElement("li");
			list.appendChild(item);
		var header = document.createElement("header");
			item.appendChild(header);
		var section = document.createElement("section");
			item.appendChild(section);
		
		header.onclick = function() { expand-expand(this); };
		header.innerHTML = "<h3>" + city["nom"] + "</h3>";
		
		var table = document.createElement("table");
			section.appendChild(table);

		table.innerHTML += "<tr><th>Code</th><td>" + city["code"] + "</td></tr>";
		table.innerHTML += "<tr><th>Département</th><td>" + city["departement"]["nom"] + "</td></tr>";
		table.innerHTML += "<tr><th>Région</th><td>" + city["region"]["nom"] + "</td></tr>";
		table.innerHTML += "<tr><th>Codes postaux</th><td>" + city["codesPostaux"] + "</td></tr>";
		table.innerHTML += "<tr><th>Population</th><td>" + city["population"] + " habitants</td></tr>";
		table.innerHTML += "<tr><th>Surface</th><td>" + city["surface"] + " m²</td></tr>";

		var canvas = document.createElement("canvas");
			section.appendChild(canvas);
		draw_polygon(canvas, city["contour"]["coordinates"][0]);
	}
}

function draw_polygon(canvas, coordinates) {
	var ctx = canvas.getContext('2d');

	ctx.fillStyle = '#f00';
	ctx.beginPath();
	ctx.moveTo(50, 50);

	for (coo of coordinates) {
		console.log(coo[0], coo[1]);
	// 	ctx.lineTo(coo[0]*10, coo[1]*10);
	}

	ctx.closePath();
	ctx.fill();
}

</script>
<style>

canvas {
	background: rgba(0, 0, 0, 0.1);
}

</style>
